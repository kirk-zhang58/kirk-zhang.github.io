
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Eden">
    <title>Category: oracle - Eden</title>
    <meta name="author" content="kirkzhang">
    
    
        <link rel="icon" href="https://simonteo58.github.io/assets/images/cover-v1.2.0.jpg">
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Eden">
<meta property="og:url" content="https://simonteo58.github.io/categories/oracle/index.html">
<meta property="og:site_name" content="Eden">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="kirkzhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@nil">
    
        <link rel="publisher" href="https://plus.google.com/nil"/>
    
    
        
    
    
        <meta property="og:image" content="https://simonteo58.github.io/assets/images/nil"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-jtle2hiadqi6creqze7vuhnn9ct7bmrwzzyznr4cpumzvckdy7pw9sbtrdse.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Eden
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">kirkzhang</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Google +"
                        >
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google +</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/mailto"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/10/19/oracle/Oracle_PLSQL_Recipes/"
                            aria-label=": Oracle PLSQL Recipes"
                        >
                            Oracle PLSQL Recipes
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-10-19T23:51:33+08:00">
	
		    Oct 19, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/oracle/">oracle</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="1-PL-x2F-SQL-Fundamentals"><a href="#1-PL-x2F-SQL-Fundamentals" class="headerlink" title="1 PL&#x2F;SQL Fundamentals"></a>1 PL&#x2F;SQL Fundamentals</h1><h2 id="1-1-创建plsql代码块"><a href="#1-1-创建plsql代码块" class="headerlink" title="1.1 创建plsql代码块"></a>1.1 创建plsql代码块</h2><p>如和创建一个可以执行的plsql代码块？</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">-- demo 1
begin
  -- 中间写代码
end;

-- demo 2


declare

-- 定义变量

begin 
 -- 业务逻辑
end;</code></pre>

<p>在实际的开发当中，这些代码块会进行嵌套，第一层代码块定义的变量，内层的代码块也可以直接使用</p>
<h2 id="1-2-在plsql种执行plsql代码块"><a href="#1-2-在plsql种执行plsql代码块" class="headerlink" title="1.2 在plsql种执行plsql代码块"></a>1.2 在plsql种执行plsql代码块</h2><p>如何在sqlplus中执行plsql代码?</p>
<p>登录sqlplus就可以直接输入自己的代码，然后<code>end;</code>结束代码块，并且接着输入<code>/</code>,这时候sqlplus解释器就可以执行代码了。<br>但是有一点需要明确，如果你的代码块是以<code>declare</code>开头的，那么就会直接输出到屏幕</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">sql&gt; begin
DBMS_OUTPUT.put_line(&quot;hello world&quot;)
end;
&#x2F;</code></pre>

<p>但是如果你想创建package,function,procedure,可以使用如下语句，方便后面的调用</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">SQL&gt; CREATE OR REPLACE PROCEDURE hello_world AS 
 BEGIN 
 DBMS_OUTPUT.PUT_LINE(&#39;Hello World&#39;); 
 END; 
 &#x2F; </code></pre>

<h2 id="1-3-store-code-in-script"><a href="#1-3-store-code-in-script" class="headerlink" title="1.3 store code in script"></a>1.3 store code in script</h2><p>如果你想通过sql脚本执行代码，该如何运行？</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">SET SERVEROUTPUT ON;
DECLARE 
 counter NUMBER;
BEGIN 
  FOR counter IN REVERSE 0..10 LOOP 
  DBMS_OUTPUT.PUT_LINE (counter); 
  END LOOP; 
END;
&#x2F;</code></pre>
<p>你可以保存你的plsql代码在脚本里,重要一步是要保证你的文件扩展名是<code>.sql</code><br>SQL Developer supports a number of additionalextensions for more specific types of PL&#x2F;SQL. </p>
<h2 id="1-4-执行你的脚本"><a href="#1-4-执行你的脚本" class="headerlink" title="1.4 执行你的脚本"></a>1.4 执行你的脚本</h2><p>登录sqlplus，然后跳(Traverse)到你的脚本目录</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">@绝对路径
@相对路径
sqlplus username&#x2F;password@database my_stored_script.sql </code></pre>

<h2 id="1-5-接受用户的输入从键盘中"><a href="#1-5-接受用户的输入从键盘中" class="headerlink" title="1.5 接受用户的输入从键盘中"></a>1.5 接受用户的输入从键盘中</h2><p>sqlplus使用&amp;符号来接受来自键盘的输入</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">DECLARE
 emp_count NUMBER; 
BEGIN 
 SELECT count(*) 
 INTO emp_count 
 FROM employees 
 WHERE department_id &#x3D; &amp;department_id; 
END; </code></pre>

<p>但是如果你想从键盘接受一个输入，但是后面又想继续使用，则可以使用如下方法</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">DECLARE
 emp_count NUMBER; 
BEGIN 
  SELECT count(*) 
  INTO emp_count 
  FROM employees 
  WHERE department_id &#x3D; &amp;&amp;department_id; 
  DBMS_OUTPUT.PUT_LINE(&#39;The employee count is: &#39; || emp_count || 
  &#39; for the department with an ID of: &#39; || &amp;department_id); 
END;
</code></pre>

<p>另外还有一种方法就是定义变量来承接从键盘来的输入,但是要注意这个变量定义的类型,如果是numeric类型的，如果是varchar2类型则需要用<code>单引号</code>,见如下代码</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">DECLARE 
    first varchar2(20); 
    last varchar2(25); 
    emp_last VARCHAR2(25) :&#x3D; &#39;&amp;last_name&#39;; 
    emp_count NUMBER; 
BEGIN 
    SELECT count(*) 
    INTO emp_count 
    FROM employees 
    WHERE last_name &#x3D; emp_last; 
 IF emp_count &gt; 1 THEN 
    DBMS_OUTPUT.PUT_LINE(&#39;More than 1 employee exists with that name.&#39;); 
 ELSE 
    SELECT first_name, last_name 
    INTO first, last 
    FROM employees 
    WHERE last_name &#x3D; emp_last; 
    DBMS_OUTPUT.PUT_LINE(&#39;The matching employee is: &#39; || 
    first || &#39; &#39; || last); 
 END IF; 
EXCEPTION 
    WHEN NO_DATA_FOUND THEN 
    DBMS_OUTPUT.PUT_LINE(&#39;Please enter a different last name.&#39;); 
END; </code></pre>

<h2 id="1-6-Displaying-Results-in-SQL-Plus"><a href="#1-6-Displaying-Results-in-SQL-Plus" class="headerlink" title="1.6 Displaying Results in SQL*Plus"></a>1.6 Displaying Results in SQL*Plus</h2><p><code>SET SERVEROUTPUT ON</code> is issued, then the default buffer size is 20,000 bytes.<br>Any content that surpasses that size will be cut off. To increase the buffer, simply set the size of buffer<br>you’d like to use when turning the SERVEROUTPUT on: </p>
<h2 id="1-7-Commenting-Your-Code"><a href="#1-7-Commenting-Your-Code" class="headerlink" title="1.7 Commenting Your Code"></a>1.7 Commenting Your Code</h2><h2 id="1-8-Referencing-a-Block-of-Code"><a href="#1-8-Referencing-a-Block-of-Code" class="headerlink" title="1.8 Referencing a Block of Code"></a>1.8 Referencing a Block of Code</h2><p>如何引用一个代码块?</p>
<p>给一个代码块添加label标签,比如下面的代码</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">
&lt;&lt;dept_block&gt;&gt;
DECLARE 
  dept_name varchar2(30); 
BEGIN 
  SELECT department_name 
  INTO dept_name 
  FROM departments 
  WHERE department_id &#x3D; 230;
  DBMS_OUTPUT.PUT_LINE(dept_name);
END dept_block;
</code></pre>

<h2 id="1-9-Referring-to-Variables-from-Nested-Blocks"><a href="#1-9-Referring-to-Variables-from-Nested-Blocks" class="headerlink" title="1.9. Referring to Variables from Nested Blocks"></a>1.9. Referring to Variables from Nested Blocks</h2><p>如果code block是嵌套关系那么该如何使用具有相同名字的变量,可以使用label来区分不同的变量名字</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">&lt;&lt;outer_block&gt;&gt;
DECLARE
  mgr_id NUMBER(6) :&#x3D; &#39;&amp;current_manager_id&#39;;
  dept_count number :&#x3D; 0;
BEGIN

SELECT count(*)
    INTO dept_count 
    FROM departments 
    WHERE manager_id &#x3D; outer_block.mgr_id;

 IF dept_count &gt; 0 THEN 
    &lt;&lt;inner_block&gt;&gt; 
    DECLARE 
      dept_name VARCHAR2(30); 
      mgr_id NUMBER(6):&#x3D; &#39;&amp;new_manager_id&#39;; 
    BEGIN 
    SELECT department_name 
    INTO dept_name 
    FROM departments 
    WHERE manager_id &#x3D; outer_block.mgr_id; 

    UPDATE departments 
    SET manager_id &#x3D; inner_block.mgr_id 
    WHERE manager_id &#x3D; outer_block.mgr_id; 
    DBMS_OUTPUT.PUT_LINE 
    (&#39;Department manager ID has been changed for &#39; || dept_name); 
    END inner_block; 
 ELSE 
    DBMS_OUTPUT.PUT_LINE(&#39;There are no departments listed for the manager&#39;); 
 END IF; 
EXCEPTION 
 WHEN NO_DATA_FOUND THEN 
    DBMS_OUTPUT.PUT_LINE(&#39;There are no departments listed for the manager&#39;); 
END outer_block; </code></pre>

<p>但是inner block创建的变量，outside block是不会读取到的,外部块变量在内部块中是可见的，而不需要完全限定名称，并且不需要块标签</p>
<h2 id="1-10-Ignoring-Substitution-Variables"><a href="#1-10-Ignoring-Substitution-Variables" class="headerlink" title="1.10. Ignoring Substitution Variables"></a>1.10. Ignoring Substitution Variables</h2><p>转义那些sqlplus使用的特殊字符</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">SQL&gt; SET ESCAPE &#39;\&#39; 
SQL&gt; INSERT INTO DEPARTMENTS VALUES( 
  departments_seq.nextval, 
  &#39;Shipping \&amp; Receiving&#39;, 
  null, 
 null);</code></pre>

<p>还有另外一种</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">SQL&gt; SET DEFINE OFF
INSERT INTO DEPARTMENTS VALUES( 
departments_seq.nextval, 
&#39;Importing &amp; Exporting&#39;, 
null, 
null); 
</code></pre>

<h2 id="1-11-Changing-the-Substitution-Variable-Character"><a href="#1-11-Changing-the-Substitution-Variable-Character" class="headerlink" title="1.11. Changing the Substitution Variable Character"></a>1.11. Changing the Substitution Variable Character</h2><p>如果你对改变替换变量符号(&amp;)为其他的符号</p>
<p>可以使用<code>set define ^</code>, 你也可以使用任意其他的符号来替换</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">SQL&gt; SET DEFINE ^
SQL&gt; SELECT department_name 
     FROM departments 
     WHERE department_id &#x3D; ^dept_id;</code></pre>

<h2 id="1-12-Creating-a-Variable-to-Match-a-Database-Column-Type"><a href="#1-12-Creating-a-Variable-to-Match-a-Database-Column-Type" class="headerlink" title="1.12. Creating a Variable to Match a Database Column Type"></a>1.12. Creating a Variable to Match a Database Column Type</h2><p>如果向查数据库中某一个表的数据，该如何将查询结果赋值给变量呢？<br>可以使用<code>%type</code>关键字,会将一列的数据赋值给变量,而<code>%rowtype</code>则是返回一列的数据给变量</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">
DECLARE
 dept_name departments.department_name%TYPE; 
 dept_id NUMBER(6) :&#x3D; &amp;department_id; 
BEGIN 
 SELECT department_name 
 INTO dept_name 
 FROM departments 
 WHERE department_id &#x3D; dept_id; 
 DBMS_OUTPUT.PUT_LINE(&#39;The department with the given ID is: &#39; || dept_name); 
EXCEPTION 
 WHEN NO_DATA_FOUND THEN 
 DBMS_OUTPUT.PUT_LINE(&#39;No department for the given ID&#39;); 
END;</code></pre>

<h1 id="2-基础sql"><a href="#2-基础sql" class="headerlink" title="2.基础sql"></a>2.基础sql</h1><h2 id="2-1-Retrieving-a-Single-Row-from-the-Database"><a href="#2-1-Retrieving-a-Single-Row-from-the-Database" class="headerlink" title="2.1 Retrieving a Single Row from the Database"></a>2.1 Retrieving a Single Row from the Database</h2><p><strong>problem</strong></p>
<p>You are interested in returning one row from a database table via a query that searches for an exact<br>match.</p>
<p><strong>solution 1</strong><br>你可以使用<code>select ... into ...</code>语法</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">DECLARE
    first VARCHAR2(20);  -- varchar2(20)一定是要兼容的数据库表字段的
    last VARCHAR2(25); 
    email VARCHAR2(25); 
BEGIN 
    SELECT first_name, last_name, email 
    INTO first, last, email 
    FROM employees 
    WHERE employee_id &#x3D; 100; 
    DBMS_OUTPUT.PUT_LINE( 
    &#39;Employee Information for ID: &#39; || first || &#39; &#39; || last || &#39; - &#39; || email); 
EXCEPTION 
WHEN NO_DATA_FOUND THEN 
    DBMS_OUTPUT.PUT_LINE(&#39;No employee matches the given ID&#39;); 
WHEN TOO_MANY_ROWS THEN
    DBMS_OUTPUT.PUT_LINE(&#39;More than one employee matches the given ID&#39;); 
END; </code></pre>

<p><strong>solution 2</strong></p>
<pre class="language-sql" data-language="sql"><code class="language-sql">DECLARE
 CURSOR emp_cursor IS 
 SELECT first_name, last_name, email 
 FROM employees 
 WHERE employee_id &#x3D; &amp;emp_id; 
 first VARCHAR2(20); 
 last VARCHAR2(25); 
 email VARCHAR2(25); 
BEGIN 
 OPEN emp_cursor; 
 FETCH emp_cursor INTO first, last, email; 
 IF emp_cursor%NOTFOUND THEN 
      RAISE NO_DATA_FOUND; 
 ELSE 
 -- Perform second fetch to see if more than one row is returned 
    FETCH emp_cursor INTO first, last, email; 
    IF emp_cursor%FOUND THEN 
      RAISE TOO_MANY_ROWS; 
    ELSE 
      DBMS_OUTPUT.PUT_LINE( 
      &#39;Employee Information for ID: &#39; || first || &#39; &#39; || last || &#39; - &#39; || email); 
      END IF;
 END IF; 
CLOSE emp_cursor; 
</code></pre>

<p><strong>how it works</strong></p>
<p>solution 1: One is to issue a SELECT…INTO statement,which is a statement designed to return just one row.<br>The other approach is to open a cursor, fetch the  one row, and close the cursor<br>solution 2: We keep an open mind on that point. Consider that if youare expecting exactly one row to be<br>returned, getting multiple rows back represents an exception case that you must somehow deal with.<br>The cursor-based solution makes it easy to simply ignore that exception case, but ignoring a condition<br>that you do not expect to occur does not change the fact that it has occurred. Although a cursor is used,<br>the cases where no data is returned or where too many rows are returnedgiven the user-supplied EMPLOYEE_ID<br>still remain a reality. However, since cursors are specifically designed to deal with zero rows or more<br>than one row coming back from a query, no exceptions will be raised if these situations occur. For this reason,<br>Solution #2 contains some conditional logic that is used to manually raise the desired exceptions.In the event that the user supplies the block with an invalid EMPLOYEE_ID, the cursor will not fetch any data. The %NOTFOUND attribute of the cursor will be checked to see whether the cursor successfully fetched data. If not, then the NO_DATA_FOUND exception is raised. If the cursor is successful in retrieving data, then a second FETCH statement is issued to see whether more than<br>one row will be returned. If more than one row is returned, then the TOO_MANY_ROWS exception is raised;<br>otherwise, the expected output is displayed. In any event, the output that is displayed using either of the<br>solutions will be the same whether successful or not.</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/10/19/oracle/Oracle_PLSQL_Recipes/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/10/11/oracle/Real_World_SQL_and_PLSQL/"
                            aria-label=": Real_World_SQL_and_PLSQL"
                        >
                            Real_World_SQL_and_PLSQL
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-10-11T14:57:52+08:00">
	
		    Oct 11, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/oracle/">oracle</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="chapter-5-Edtion-Baseed-Redefinition"><a href="#chapter-5-Edtion-Baseed-Redefinition" class="headerlink" title="chapter 5 Edtion_Baseed Redefinition"></a>chapter 5 Edtion_Baseed Redefinition</h1><p>升级数据库应用程序总是需要停机；根本不可能替换正在使用的PL&#x2F;SQL对象。</p>
<h2 id="5-1-Planned-Downtime"><a href="#5-1-Planned-Downtime" class="headerlink" title="5.1 Planned Downtime"></a>5.1 Planned Downtime</h2><p>unplaned downtime是很难预料的，可以通过使用备机来减少downtime，但是完全消除downtime是不可能的<br>硬件故障可以切换到物理或者逻辑备用数据库继续提供服务，一直以来，没有办法在运行时替换PL&#x2F;SQL而不影响服务的运行。<br>某一PL&#x2F;SQL object只能有一个版本。当你替换object时候，整个object是被锁住的。<br>planed downtime : 贵公司计划的downtime时间</p>
<p>With edition-based redefinition, you can create PL&#x2F;SQL changes in the privacy of an edition. Then, when the custom application is updated, it can be released to the users. Newly connecting users will use the new application objects, while the users who were using the application during the upgrade can continue to work as if nothing happened. When the last of the users has disconnected from the pre-upgraded application, that application can be retired and only the post-upgraded application will be available for use.</p>
<h2 id="5-2-Terminology-Used（专业术语）"><a href="#5-2-Terminology-Used（专业术语）" class="headerlink" title="5.2 Terminology Used（专业术语）"></a>5.2 Terminology Used（专业术语）</h2><p>patch : 当程序没有实现需求所规定的内容时，需要应用补丁来纠正，实现程序和需求一致。补丁应该使程序符合需求所规定的。<br>upgrade : 当需求在程序创建后发生变化。（跟patch的区分不是太清晰，当文本中提到 “升级 “时，也可理解为一个补丁，反之亦然）。</p>
<h2 id="5-3-The-Concept"><a href="#5-3-The-Concept" class="headerlink" title="5.3 The Concept"></a>5.3 The Concept</h2><p>EBR解决的三个挑战</p>
<ol>
<li>首先，当有人在使用一个应用程序时，你怎么能对其进行修改？对一个应用程序进行修改通常涉及许多对象的修改，但你不能一个接一个地修改它们。这将使应用程序处于invalid的状态 ,有可能用升级前的数据库应用程序对数据库进行完整的复制，并进行必要的修改以达到升级后的状态，这就解决了第一个问题。另一个选择是复制数据库schema，并在这个schema中进行修改。</li>
<li>随之而来的第二个问题，如何在两个应用程序（升级前的应用程序和升级后的应用程序）之间保持数据的同步？你可以想象，这不是一件容易做到的事情。原来的数据库对象仍然在使用，数据继续导入和改变。必须有一种机制，允许数据变化在升级前和升级后的应用程序之间传播。</li>
<li>表结构的升级。</li>
</ol>
<p>EBR三个优点<br>Changes are made in the privacy of a new edition.<br>相同表的不同版本（pre,post）是通过使用编辑视图实现的.<br>在热更新期间，跨版本的触发器将使不同版本之间的数据变化保持同步.</p>
<p>high risk</p>
<pre class="language-none"><code class="language-none">Implementing edition-based redefinition is not as trivial as flipping a switch. 
The preparation phase of edition-based redefinition is very important and might 
require changing the existing database design and database source code</code></pre>

<pre class="language-txt" data-language="txt"><code class="language-txt">If, for whatever reason, the edition-based redefinition exercise fails 
and the edition must be removed, the edition can be dropped by a single 
statement.Keep in mind, though, that changes to the table are not reversed 
when an edition is dropped from the database. Also, changes to the data 
are not reversed and should be removed as well to return to the pre-upgraded version.</code></pre>

<h2 id="5-4-Preparation-Enable-Editions"><a href="#5-4-Preparation-Enable-Editions" class="headerlink" title="5.4 Preparation: Enable Editions"></a>5.4 Preparation: Enable Editions</h2><ol>
<li>启动EBR<pre class="language-sql" data-language="sql"><code class="language-sql">alter user scott enable editions</code></pre></li>
<li>不能disable这个操作<br>12.1之前是enable整个schema的object为editionable,12.1之后可以指定aditionable为non-editionable.</li>
</ol>
<h2 id="5-4-1-NE-non-editionable-on-E-editionable-Prohibition"><a href="#5-4-1-NE-non-editionable-on-E-editionable-Prohibition" class="headerlink" title="5.4.1 NE(non-editionable) on E(editionable) Prohibition"></a>5.4.1 NE(non-editionable) on E(editionable) Prohibition</h2><p>这句话怎么翻译比较贴切？— It is not possible for noneditionable objects to depend on editionable objects. This is called the NE on E prohibition.<br>user-defined type : 可能就是复合数据类型，由基础数据类型组成</p>
<p>在Oracle数据库12.1之前，当你想对一个schema启用编辑时，你必须解决NE on E的问题。例如，当你有一个user-defined type被用于表的定义时，你就违反了NE on E prohibition。一个用户定义的类型是可编辑的，而一个表永远不能被编辑。当你需要遵守12.1版本之前的zero downtime要求时，不可避免地需要改变你的模式设计。</p>
<p>从Oracle数据库12.1开始，可以通过明确地将某些对象设置为不可编辑来定义对象。这只能在edition-enable之前实现。一旦一个object被设置为不可编辑，并且edition enabled，其状态就会被固定，不能被改变。试图这样做将导致以下异常。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">ORA-38825: The EDITIONABLB property of an editioned object cannot be altered.</code></pre>

<p>演示对某一个用户(账号)启动EBR,分析NE on E prohibition具体例子，<br>创建一个新用户</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">create user neone identified by neone
&#x2F;
grant connect,create table,create type to neone
&#x2F;
alter user neone quota unlimited on users
&#x2F;</code></pre>

<p>接着用该账号创建user-defined type</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">create type phone_number_ot as object(
   type_name varchar2 (10)
,  phone_number varchar2(20)
)
&#x2F;
</code></pre>

<p>基于上面的type object创建数据库的表</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">create type phone_numbers_tt as table of phone_number_ot
&#x2F;
create table emps( 
   empno number
,  phone_numbers phone_numbers_tt
)
nested table phone_numbers store as phone_numbers_nt
</code></pre>

<p>这时候尝试启动EBR,就会碰到如下问题</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">alter user neone enable editions
&#x2F;
ERRORat line l:
ORA-38819: user NEONE owns one or more objects whose type is editionableand that have noneditioned dependent objects
</code></pre>
<p>这是因为你的type类型是editionable的，table类型是non-aditionable的，EBR不允许有这样的依赖关系，这样是12.1版本之前必须要该schema的table和source code的设计，12.1之后我们可以实现将NE编程E从而解决这个问题。通过如下可以解决NE on E问题</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">
alter type phone_numbers_tt noneditionable
&#x2F;
alter type phone_number_ot noneditionable
&#x2F;
</code></pre>

<p>另外，上面相同的例子，还有有第二种情况，如果是已经启动EBR，然后基于user-defined type创建表就会报错</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">
create table emps*
ERROR at line 1:
ORA-38818: illegal reference to editioned object neone.PHONE_NUMBBR_OT
</code></pre>
<p>因为第二种情况下neone已经启动了EBR,这时候你也无法把将edtionable的type类型改变为non-aditionable</p>
<p>如果测试，生产环境中真碰到了这个问题，我们该如何的解决这个问题呢?<br>需要我们重新创建type类型，这样才能保证我们成功创建基于type类型的table</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">drop type phone_numbers_tt
&#x2F;
Type dropped.
drop type phone_number_ot
&#x2F;
Type dropped.

create or replace noneditionable type phone_number_ot as object
( type_name varchar2 (10)
, phone_number varchar2 (20)
)
&#x2F;
Type created

create or replace noneditionable type phone_numbers_tt as table of phone_number_ot
&#x2F;
Type created.

create table emps(
   empno number
,  phone_numbers phone_numbers_tt
)
nested table phone_numbers store as phone_numbers_nt
&#x2F;

Table created
</code></pre>

<p>现在总结如下:</p>
<ol>
<li>如果数据库中存在NE on E的情况，在12.1之前是启动不了EBR，需要改设计</li>
<li>在12.1之前版本启动了EBR,那么在之后的表设计当中就要避开NE on E的问题</li>
<li>如果真出了NE on E的问题，可以通过重新创建type,然后重新创建表来解决</li>
</ol>
<p>遗留问题尚待解决:</p>
<ol>
<li>如果你的架构中使用ogg，data guard，RAC等等oracle系的组件，<br>要如何保证他们不停机维护，也要把他们考虑进去</li>
</ol>
<h2 id="5-4-2-Create-a-new-edition"><a href="#5-4-2-Create-a-new-edition" class="headerlink" title="5.4.2 Create a new edition"></a>5.4.2 Create a new edition</h2><p>因为用户SCOTT启用了edition，所以我们可以创建一个额外的edition。版本之间有一个层次关系，其中一个edition总是有一个父edition这里唯一的例外是ORA$BASE，或者当这个edition最终被删除时，是层次结构中的下一个版本——根edition。<br>为了创建一个新版本，需要系统权限<code>create ANY edition</code>:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">grant create any edition on scott</code></pre>

<p>在创建版本之前，还需要将用作父版本的版本上的USE特权。一个版本总是作为另一个版本的子版本创建。创建版本时，会自动授予USE对象特权。USE权限也可以单独授予，如下面的代码示例所示:</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">grant use on edition &lt;edition_name&gt; to &lt;user&gt;</code></pre>

<p>这里，<code>&lt;edition_name&gt;</code>和<code>&lt;user&gt;</code>需要用edition的名称和你想授予权限的用户来代替。<br>为了删除根edition或leaf edition，需要有<code>DROP ANY EDITION</code>系统权限。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">grant drop any edition to scott</code></pre>

<p>当你连接到一个数据库时，可以通过使用ALTER语句来改变版本，比如在下一个例子中，其中<code>&lt;edition_name&gt;</code>是指应该改成你想改成的版本。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">alter session set edition &#x3D;&lt;edition_name&gt;</code></pre>
<p>请记住，如果application有未完成的事务，这时候是不用change你的edition,否则你将会碰到如下error。</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">alter session set edition &#x3D;r2
error:
ora-38814:alter session set edition must be first statement of transaction
</code></pre>

<h2 id="5-5-Complexity-levels"><a href="#5-5-Complexity-levels" class="headerlink" title="5.5 Complexity levels"></a>5.5 Complexity levels</h2><p>使用EBR包括了多层复杂因素<br>first level : PLSQL object结构change,有哪些在edition之间<br>second level : table struct change among edition<br>在同一时间不需要维护多个版本的edition因为在将来所有的user都会使用post-upgrade edition<br>third level : complex level is where you do have table structure changes and the users need to access multiple editions at the same time ,thus keeping data in sync between multiple editions.</p>
<h3 id="5-5-1-replace-PLSQL-code"><a href="#5-5-1-replace-PLSQL-code" class="headerlink" title="5.5.1 replace PLSQL code"></a>5.5.1 replace PLSQL code</h3><p>接下来阐述了在不同edition之间，不同的functionality可以有相同的名字<br>下面sql可以查看当前edition名字</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">select sys_context(&#39;userenv&#39;,
                   &#39;current_edition_name&#39;) as &quot;current_edition&quot;from dual;</code></pre>
<p>也可以通过<code>show edition</code>来查询当前edition.</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/10/11/oracle/Real_World_SQL_and_PLSQL/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/10/11/oracle/Oracle_EBR/"
                            aria-label=": Edition-Based Redefinition Technical Deep Dive"
                        >
                            Edition-Based Redefinition Technical Deep Dive
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-10-11T12:13:46+08:00">
	
		    Oct 11, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/oracle/">oracle</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="INTRODUCTION"><a href="#INTRODUCTION" class="headerlink" title="INTRODUCTION"></a>INTRODUCTION</h1><p>当应用程序的数据库组件在应用程序升级过程中被更新时，大型的关键的应用程序可能会经历几十个小时，甚至更长的停机时间。app的数据库组件在应用程序升级期间进行更新。Oracle数据库推出了基于版本的重新定义（EBR），这是一项革命性的功能，可以在不间断的情况下在线升级应用程序。革命性的功能，它允许在线应用升级，并保证应用的不间断可用性。</p>
<p>EBR的功能是同时维护两个版本的应用程序。当升级的安装完成后。<br>升级前(pre-upgrade application)的应用程序和升级后(post-upgrade application)<br>的应用程序可以同时使用。因此，一个现有的会话可以 继续使用升级前的应用程序，直到<br>其用户决定结束它；而所有新的会话可以使用升级后的应用程序。在所有会话与它断开连接后，<br>升级前的应用程序就可以退役了。换句话说，该 应用程序作为一个整体享有从升级前版本到<br>升级后版本的热迁移。</p>
<p>为了利用这种能力，应用程序的数据库后端必须通过一些一次性的schema改变来启用EBR。<br>另外，<strong>执行应用程序升级的脚本必须以使用EBR功能的方式来编写</strong>。因此，EBR的采用和后续使用是开发车的事情。</p>
<p>为了实现在线应用升级2，必须满足以下条件。</p>
<ul>
<li><p>改变后的数据库对象的安装不能影响到升级前应用程序的实时用户。</p>
</li>
<li><p>升级前应用程序的用户所做的交易必须反映在升级后的应用程序中。</p>
</li>
<li><p>升级后应用程序的用户进行的交易必须反映在升级前的应用程序中。</p>
</li>
</ul>
<p>Oracle数据库通过一种称为基于版本的重新定义（EBR）的革命性功能实现了这一点。</p>
<p>Using EBR:</p>
<ul>
<li><p>代码修改是在新版本的隐私中安装的。</p>
</li>
<li><p>数据的改变是通过只写入新的列或新的表来实现的，而旧版本是看不到的。这是<br>这是通过一个编辑视图来实现的，该视图将一个表的不同投影暴露在每个版本中，因此每个版本只看到自己的列。<br>看到自己的列。</p>
</li>
<li><p>跨版本触发器将旧版本的数据变化传播到新版本的公共列中，或者（在hot-rollover）反之亦然。</p>
</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/10/11/oracle/Oracle_EBR/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/08/31/oracle/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA_Oracle_DBA_%E5%85%A5%E9%97%A8_%E8%BF%9B%E9%98%B6%E4%B8%8E%E8%AF%8A%E6%96%AD%E6%A1%88%E4%BE%8B/"
                            aria-label=": 深入浅出_Oracle_DBA_入门_进阶与诊断案例"
                        >
                            深入浅出_Oracle_DBA_入门_进阶与诊断案例
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-08-31T17:35:04+08:00">
	
		    Aug 31, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/oracle/">oracle</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="1-数据库额启动与关闭"><a href="#1-数据库额启动与关闭" class="headerlink" title="1. 数据库额启动与关闭"></a>1. 数据库额启动与关闭</h1><p>oracle server分为两部分(database: 这部分是指文件系统上的数据，instance则是指后台运行的线程和部分共享内存)。<br>并且数据启动分为三部分：1. <code>nomount</code>  2. <code>mount</code>  3. <code>open</code> 状态</p>
<ol>
<li>启动到nomount状态</li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/08/31/oracle/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA_Oracle_DBA_%E5%85%A5%E9%97%A8_%E8%BF%9B%E9%98%B6%E4%B8%8E%E8%AF%8A%E6%96%AD%E6%A1%88%E4%BE%8B/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 kirkzhang. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">kirkzhang</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                nil
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-oejgoqwxqxfpwex5ev6ukctltwog5vlqaetakgrj0ys9pwba1gtnkqh5ga78.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
