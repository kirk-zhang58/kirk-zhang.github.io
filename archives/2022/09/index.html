
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Eden">
    <title>Archives: 2022/9 - Eden</title>
    <meta name="author" content="kirkzhang">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Eden">
<meta property="og:url" content="https://simonteo58.github.io/archives/2022/09/index.html">
<meta property="og:site_name" content="Eden">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="kirkzhang">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@nil">
    
        <link rel="publisher" href="https://plus.google.com/nil"/>
    
    
        
    
    
        <meta property="og:image" content="https://simonteo58.github.io/assets/images/nil"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-jtle2hiadqi6creqze7vuhnn9ct7bmrwzzyznr4cpumzvckdy7pw9sbtrdse.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Eden
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">kirkzhang</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="Google +"
                        >
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google +</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/nil"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/mailto"
                            
                            rel="noopener"
                            title="Mail"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/09/26/%E9%9A%8F%E7%AC%94/%E8%B4%B9%E6%9B%BC:%E4%BB%BB%E4%BD%95%E4%BC%9F%E5%A4%A7%E7%9A%84%E7%A7%91%E5%AD%A6%E6%88%90%E5%B0%B1%E9%83%BD%E6%BA%90%E4%BA%8E%E6%80%9D%E6%83%B3%E8%87%AA%E7%94%B1/"
                            aria-label=": 费曼:任何伟大的科学成就，都源于思想自由"
                        >
                            费曼:任何伟大的科学成就，都源于思想自由
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-09-26T00:05:55+08:00">
	
		    Sep 26, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="费曼：任何伟大的科学成就，都源于思想自由"><a href="#费曼：任何伟大的科学成就，都源于思想自由" class="headerlink" title="费曼：任何伟大的科学成就，都源于思想自由"></a>费曼：任何伟大的科学成就，都源于思想自由</h1><blockquote>
<p>原文地址 : <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/p_l9_Z54jewLN6SEjio1Tw">https://mp.weixin.qq.com/s/p_l9_Z54jewLN6SEjio1Tw</a></p>
</blockquote>
<p><img src="/./../../picture/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220926005909.jpg" alt="费曼"></p>
<h2 id="科学的价值"><a href="#科学的价值" class="headerlink" title="科学的价值"></a>科学的价值</h2><p>当我年轻的时候，我认为科学会有利于每个人。科学显然很有用，也是很有益的。在第二次世界大战中，我参与了原子弹的制造工作。科学的发展导致了原子弹的产生，这显然是一个具有极其严肃意味的事件：它代表着对人类的毁灭。</p>
<p>战后，我对原子弹忧心忡忡，既不知未来会怎样，也更不敢肯定人类一定会延存。自然地，一个问题会这样被提出：科学是不是包含着邪恶的成分？</p>
<p>这个问题也可以这样来问：当我们看到科学也可以带来灾难时，那么我如此热爱，并且毕生孜孜为之的科学事业的价值究竟何在？这是我无法回避的问题。</p>
<p>这篇“科学的价值”，你们可以把它看成是我在探索这个问题时的所思所悟。</p>
<p>——理查德·费曼</p>
<p>时常，人们对我提出，科学家应该多多关心社会问题，特别是要考虑科学对于社会的影响。人们似乎相当普遍地认为，只要科学家们对于错综复杂的社会问题加以关注，而不是成天钻在枝尾末节的科学研究之中，那么巨大的成功就会自然到来。</p>
<p>我以为，我们科学家是很关注这些社会问题的，只不过我们不是把它们当作自己的全职而已。其原因是，对于这些比科学研究复杂千百倍的社会问题，我们也是百思不得其解，绝无灵丹妙药。</p>
<p>我认为当科学家思考非科学问题时，他和所有的人一样无知；当他要对非科学问题发表见解时，他和所有的门外汉一样幼稚。今天我的讲演“科学的价值”所针对的并不是一个科学课题，而是价值评判；这样看来，我下面将要讲的大概也是粗浅不堪的了。</p>
<h2 id="01"><a href="#01" class="headerlink" title="01"></a>01</h2><p><strong>科学的价值的第一点是众所周知的。科学知识使人们能制造许多产品、做许多事业</strong>。当然，当人们运用科学做了善事的时候，功劳不仅归于科学本身，而且也归于指导着我们的道德选择。科学知识给予人们能力去行善，也可以作恶，它本身可并没有附带着使用说明。这种能力显然是有价值的，尽管好坏决定于如何使用它。</p>
<p>在一次去夏威夷的路途中，我学会了一种方法来表达上述问题——一个佛堂的主持向游客们谈及佛学，最后他说他的临别赠言将使游客们永不忘却（我是真的从未忘却）。这赠言是佛经中的一句箴语：“每个人都掌握着一把开启天堂之门的钥匙，这把钥匙也同样能打开地狱之门。”</p>
<p>如此说来，开启天堂之门的钥匙又有什么价值呢？如果我们没有办法分辨一扇门是通向天堂还是地狱，那么手中的钥匙可是个危险的玩艺儿。</p>
<p>可是这钥匙又确实有它的价值——没有它，我们无法开启天堂之门；没有它，我们即使明辨了天堂与地狱，也还是束手无策。这样推论下来，尽管科学知识可能被误用以导致灾难，它的这种产生巨大影响的能力本身是一种价值。</p>
<pre class="language-text" data-language="text"><code class="language-text">这里的钥匙可以理解为科学知识,或者利用科学知识创造的产品,这一段主要阐述科学的其中一个价值</code></pre>
<h2 id="02"><a href="#02" class="headerlink" title="02"></a>02</h2><p><strong>科学的另一个价值是提供智慧与思辨的享受</strong>。这种享受一些人可以从阅读、学习、思考中得到，而另一些人则要从真正的深入研究中方能满足。这种智慧思辨享受的重要性往往被人们忽视，特别是那些喋喋不休地教导我们科学家要承担社会责任的先生们。</p>
<p>我当然不是说个人在智慧思辨中的享受是科学的全部价值所在。不过，<strong>如果我们社会进步的最终目标正是为了让各种人能享受他想做的事，那么科学家们思辨求知的享受也就和其他事具有同等的重要性了。</strong></p>
<p><strong>另外一个不容低估的科学的价值是它改变了人们对世界的概念</strong>。由于科学的发展，我们今天可以想象无穷奇妙的东西，比诗人和梦想者的想象丰富离奇千万倍。自然的想象和多姿比人类要高明得多。比如吧，诗人想象巨大的海龟驮着大象到海里旅行；而科学给了我们一幅图画——天宇中一个巨大的球在旋转；在它的表面，人们被神奇的引力吸住，并附着它在旋转。</p>
<p>我常常想这些奇妙的东西，这些从前人们根本不可想象，而如今科学知识使我们可以想象的东西。</p>
<p>曾经，我站在海边的沙滩上，陷入了这样的深思：</p>
<blockquote>
<p>潮起潮落<br>无法计数的分子各自孤独地运行<br>相距遥远却又息息相关<br>泛起和谐的白浪<br>旷代久远  </p>
<p>在尚无生物的上古<br>眼睛还未出现<br>年复一年<br>惊涛拍岸如今<br>为了谁，为了什么？<br>在一个死寂的星球<br>没有为之欣悦的生命   </p>
<p>永无休止<br>骄阳弥散着能量<br>射向无垠的宇宙<br>掀动着大海的波浪<br>大洋深处<br>分子重复不变<br>忽然，萌生新的组合<br>它们会复制自身<br>由此演出了全新的一幕  </p>
<p>愈变愈大<br>愈变愈复杂<br>生物，DNA，蛋白质<br>它们的舞蹈愈加神奇  </p>
<p>跃出海洋<br>走向陆地<br>站立着<br>具有认知力的原子<br>具有好奇心的物质  </p>
<p>凭海向洋<br>一个好奇者在好奇<br>我——<br>一个原子的宇宙<br>一个宇宙中的原子  </p>
</blockquote>
<p>这样的激动、惊叹和神秘，在我们研究问题时一次又一次地出现。<strong>知识的进步总是带来更深、更美妙的神秘，吸引着我们去更深一层地探索</strong>。有时探索的结果令人失望，可这又有什么关系？我们总是兴致勃勃而自信地深钻下去，发现无法想象的奇妙和随之而来的更深更美妙的神秘。这难道不是最激动人心的探索么！</p>
<p>诚然，没有过科学研究经历的人大概不会有这种近似宗教的感受。诗人不会写它，艺术家也无法描述这种奇妙的感受。我很是不解——难道他们都不为我们所发现的宇宙所激动吗？歌唱家现在还不会歌唱科学带来的神奇美妙，科学对于人们来说还是在讲课中接受的，而不是在诗与歌之中。这说明我们还没有进入一个科学的时代。</p>
<p>这种沉默无歌的原因之一，大概是人们必须懂得如何读这种音乐的乐谱才能歌唱。比如，一篇科学论文说，“鼠的脑中放射标记的磷在两周中减了一半。”这是什么意思呢？</p>
<p>它的意思是鼠脑中（你、我的脑子也没什么差别）的磷有一半已经不是两周前的原子了，它们已被替换了。那么我要问：“究竟什么是载有意识的分子呢？子虚乌有么？这些全新的分子能承载一年前在我脑中的记忆，可当时发生记忆的分子却早已被置换了！这个发现就像是说我这个体仅仅是一个舞蹈的编排。分子们进入我的大脑，跳了一场舞就离开了；新的分子又进来，还是跳和昨天一模一样的舞蹈——它们能记住！”</p>
<p>有时我们会从报纸上念到这样的话：“科学家认为这项发现对于治疗肿瘤是十分重要的……”。<strong>看，这报道只注重那项发现有什么可利用之处，而完全丢开了它本身的意义。而实际上它是多么奇妙啊！偶尔，小孩子反倒会意识到那些意义；此时，一个科学家的苗子出现了。如果当他们上大学时我们才教他们这些，那就太晚了。我们必须从孩童教起。</strong></p>
<pre class="language-text" data-language="text"><code class="language-text">科学本身的为什么着实让人着迷</code></pre>
<h2 id="03"><a href="#03" class="headerlink" title="03"></a>03</h2><p>现在，我来谈谈科学的第三个价值——它稍稍有些间接，不过并不牵强。<strong>科学家们成天经历的就是无知、疑惑、不确定，这种经历是极其重要的</strong>。当科学家不知道答案时，他是无知的；当他心中大概有了猜测时，他是不确定的；即便他满有把握时，他也会永远留下质疑的余地。承认自己的无知，留下质疑的余地，这两者对于任何发展都必不可少。科学知识本身是一个具有不同层次可信度的集合体：有的根本不确定，有的比较确定，但没有什么是完全确定的。</p>
<p>科学家们对上述情形习以为常，他们自然地由于不确定而质疑，而且承认自己无知。但是我认为大多数人并不明白这一点。在历史上科学与专制权威进行了反复的斗争才渐渐赢得了我们质疑的自由。那是一场多么艰辛、旷日持久的战斗啊！它终于使我们可以提问、可以质疑、可以不确定。我们绝不应该忘记历史，以致丢失千辛万苦争来的自由。这，是我们科学家对社会的责任。</p>
<p>人类的潜能之大、成就之小，令人想起来未免神伤，总觉得人类可以更好。先人在恶魇中梦想未来；我们（正是他们的未来）则看到他们的梦想有些已经成真，大多却仍然是梦想，一如往日。</p>
<p>有人说教育的不普及是人类不能前行的原因。可是难道教育普及了，所有的人就都能成为伏尔泰吗？坏的和好的是同样可以被传授的；教育同样拥有趋善或趋恶的巨大能力。</p>
<p>另一个梦想是国与国之间的充分交流一定会增加互相理解。可是交流的工具是可以被操纵的。如此说来所交流的既可以是真实，也可以是谎言。交流也具有趋善和趋恶双重可能。</p>
<p>应用科学可以解决人们的物资需求，医药可以控制疾病——看上去总算尽善尽美了吧？可偏偏有不少人在专心致志地制造可怖的毒物、细菌，为化学生物战争做准备。</p>
<p>几乎谁都不喜欢战争，和平是人类的梦想——人们尽可能地发挥潜能。可没准儿未来的人们发现和平也可好可坏。没准儿和平时代的人因没有挑战而厌倦不堪，于是终日痛饮不止，而醉熏熏的人并不能发挥潜能、成就大业。<br>和平显然是一个很大的力量，如同严谨、物资发展、交流，教育、诚实和先人的梦想。与先人相比，我们确实进步了，有更多的能力了。可与我们能够成就的相比，所达到的就相形见绌。</p>
<p>原因何在？为什么我们就无法战胜自己？</p>
<p>因为我们发现，巨大的潜能和力量并没有带着如何使用它们的说明书。譬如，对物质世界认识愈多，人们就愈觉得世界真是毫无目的意义可言。科学并无法指导行善或行恶。  </p>
<pre class="language-text" data-language="text"><code class="language-text">科学并不会指导善与恶</code></pre>

<h2 id="04"><a href="#04" class="headerlink" title="04"></a>04</h2><p>有史以来，人们一直都在探究生命的意义。他们想：如果有某种意义和方向来指导，人的伟大潜能定会充分发挥。于是有了许多种对生命意义的阐述和教义。这些各自不同的教义有着自己的信徒，而某一种教义的信徒总是怀着恐惧的心情看待其余教义的信徒。这种恐惧来自于信念的互不相容，致使原本良好的出发点都汇入了一条死胡同。<strong>事实上，正是从这些历史上错误信仰所制造的巨大谬误中，哲学思考者们慢慢发现了人类美妙无限的能力。人们梦想能发现一条通途</strong>。</p>
<p>那么，这些又有什么意义呢？我们如何来解开存在之谜呢？</p>
<p>如果把所有的加以考量——不仅是先人所知，而且他们不知而我们今天所知的——那么我认为我们必须坦率地承认，我们还是知之甚微。</p>
<p>不过，正当我们如此承认的时候，我们便开始找到了通途。</p>
<p>这并非一个新观念，它是理性时代的观念，也正是它指导着先贤们缔造了我们今日享用的民主制度。正因为相信没有一个人绝对懂得如何管理政府，我们才有这样一个制度来保证新的想法可以产生发展、被尝试运用、并在必要的时候被抛弃；更新的想法又可以如此地轮回运行。这是—种尝试——纠偏的系统方法。这种系统方法的建立，正是因为在18世纪末，科学已经成功地证明了它的可行性。在那时，关注社会的人们已经意识到：<strong>对各种可能性持开明态度便带来机会；质疑和讨论是探索未知的关键，如果我们想解决以前未能解决的问题，那我们就必须这样地把通向未知的门开启</strong>。</p>
<p><strong>人类还处在初始阶段，因此我们遇上各种问题是毫不奇怪的。好在未来还有千千万万年。我们的责任是学所能学、为所可为、探索更好的办法，并传给下一代。我们的责任是给未来的人们一双没有束缚自由的双手</strong>。在人类鲁莽冲动的青年期，人们常会制造巨大的错误而导致长久的停滞。倘若我们自以为对众多的问题都已有了明白的答案，年轻而无知的我们一定会犯这样的错误。如果我们压制批评，不许讨论，大声宣称“看哪，同胞们，这便是正确的答案，人类得救啦！”我们必然会把人类限制在权威的桎梏和现有想象力之中。这种错误在历史上屡见不鲜。</p>
<p><strong>作为科学家，我们知道伟大的进展都源于承认无知，源于思想的自由。那么这是我们的责任——宣扬思想自由的价值，教育人们不要惧怕质疑而应该欢迎它、讨论它，而且毫不妥协地坚持拥有这种自由——这是我们对未来千秋万代所负有的责任。</strong></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/09/26/%E9%9A%8F%E7%AC%94/%E8%B4%B9%E6%9B%BC:%E4%BB%BB%E4%BD%95%E4%BC%9F%E5%A4%A7%E7%9A%84%E7%A7%91%E5%AD%A6%E6%88%90%E5%B0%B1%E9%83%BD%E6%BA%90%E4%BA%8E%E6%80%9D%E6%83%B3%E8%87%AA%E7%94%B1/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/09/09/archive/golang_concurrency_map/"
                            aria-label=": concurreny-map代码阅读"
                        >
                            concurreny-map代码阅读
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-09-09T16:43:34+08:00">
	
		    Sep 09, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/archive/">archive</a>, <a class="category-link" href="/categories/archive/golang/">golang</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>学习下别人如何写的golang的concurrent map实现并于官方版本的进行对比。接下来的内容来自于作者的readme—-在Go 1.9之前，go语言标准库中并没有实现并发<code>map</code>。在Go 1.9中，引入了<code>sync.Map</code>。新的<code>sync.Map</code>与此<code>concurrent-map</code>有几个关键区别。标准库中的<code>sync.Map</code>是专为<code>append-only</code>场景设计的。因此，如果您想将<code>Map</code>用于一个类似内存数据库，那么使用我们的版本可能会受益。你可以在golang repo上读到更多，<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/21035">这里</a> and <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11063473/map-with-concurrent-access">这里</a><br><em><strong>译注:<code>sync.Map</code>在读多写少性能比较好，否则并发性能很差</strong></em></p>
<h2 id="第三方conrrency-map理解"><a href="#第三方conrrency-map理解" class="headerlink" title="第三方conrrency map理解"></a>第三方conrrency map理解</h2><blockquote>
<p>源代码地址 : <a target="_blank" rel="noopener" href="https://github.com/orcaman/concurrent-map">https://github.com/orcaman/concurrent-map</a></p>
</blockquote>
<details>
<summary>golang-concurrency-map</summary>

<pre class="language-golang" data-language="golang"><code class="language-golang">package cmap

import (
	&quot;encoding&#x2F;json&quot;
	&quot;sync&quot;
)

var SHARD_COUNT &#x3D; 32


&#x2F;&#x2F; A &quot;thread&quot; safe string to anything map.
type ConcurrentMapShared[V any] struct &#123;
	items        map[string]V
	sync.RWMutex &#x2F;&#x2F; Read Write mutex, guards access to internal 

&#125;

&#x2F;&#x2F; A &quot;thread&quot; safe map of type string:Anything.
&#x2F;&#x2F; To avoid lock bottlenecks this map is dived to several (SHARD_COUNT) map shards.
type ConcurrentMap[V any] []*ConcurrentMapShared[V]


&#x2F;&#x2F; 创建了一个长度32的切片
&#x2F;&#x2F; Creates a new concurrent map.
func New[V any]() ConcurrentMap[V] &#123;
	m :&#x3D; make(ConcurrentMap[V], SHARD_COUNT)
	for i :&#x3D; 0; i &lt; SHARD_COUNT; i++ &#123;
		m[i] &#x3D; &amp;ConcurrentMapShared[V]&#123;items: make(map[string]V)&#125;
	&#125;
	return m
&#125;

&#x2F;&#x2F; GetShard returns shard under given key
func (m ConcurrentMap[V]) GetShard(key string) *ConcurrentMapShared[V] &#123;
	return m[uint(fnv32(key))%uint(SHARD_COUNT)]
&#125;
&#x2F;&#x2F; batch赋值数据
func (m ConcurrentMap[V]) MSet(data map[string]V) &#123;
	for key, value :&#x3D; range data &#123;
		shard :&#x3D; m.GetShard(key)
		shard.Lock()
		shard.items[key] &#x3D; value
		shard.Unlock()
	&#125;
&#125;

&#x2F;&#x2F; Sets the given value under the specified key.
func (m ConcurrentMap[V]) Set(key string, value V) &#123;
	&#x2F;&#x2F; Get map shard.
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	shard.items[key] &#x3D; value
	shard.Unlock()
&#125;

&#x2F;&#x2F; Callback to return new element to be inserted into the map
&#x2F;&#x2F; It is called while lock is held, therefore it MUST NOT
&#x2F;&#x2F; try to access other keys in same map, as it can lead to deadlock since
&#x2F;&#x2F; Go sync.RWLock is not reentrant
type UpsertCb[V any] func(exist bool, valueInMap V, newValue V) V

&#x2F;&#x2F; Insert or Update - updates existing element or inserts a new one using UpsertCb
&#x2F;&#x2F; 有就更新，没有就插入
func (m ConcurrentMap[V]) Upsert(key string, value V, cb UpsertCb[V]) (res V) &#123;
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	v, ok :&#x3D; shard.items[key]
	res &#x3D; cb(ok, v, value)
	shard.items[key] &#x3D; res
	shard.Unlock()
	return res
&#125;

&#x2F;&#x2F; Sets the given value under the specified key if no value was associated with it.
func (m ConcurrentMap[V]) SetIfAbsent(key string, value V) bool &#123;
	&#x2F;&#x2F; Get map shard.
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	_, ok :&#x3D; shard.items[key]
	if !ok &#123;
		shard.items[key] &#x3D; value
	&#125;
	shard.Unlock()
	return !ok
&#125;

&#x2F;&#x2F; Get retrieves an element from map under given key.
func (m ConcurrentMap[V]) Get(key string) (V, bool) &#123;
	&#x2F;&#x2F; Get shard
	shard :&#x3D; m.GetShard(key)
	shard.RLock()
	&#x2F;&#x2F; Get item from shard.
	val, ok :&#x3D; shard.items[key]
	shard.RUnlock()
	return val, ok
&#125;

&#x2F;&#x2F; Count returns the number of elements within the map.
func (m ConcurrentMap[V]) Count() int &#123;
	count :&#x3D; 0
	for i :&#x3D; 0; i &lt; SHARD_COUNT; i++ &#123;
		shard :&#x3D; m[i]
		shard.RLock()
		count +&#x3D; len(shard.items)
		shard.RUnlock()
	&#125;
	return count
&#125;

&#x2F;&#x2F; Looks up an item under specified key
func (m ConcurrentMap[V]) Has(key string) bool &#123;
	&#x2F;&#x2F; Get shard
	shard :&#x3D; m.GetShard(key)
	shard.RLock()
	&#x2F;&#x2F; See if element is within shard.
	_, ok :&#x3D; shard.items[key]
	shard.RUnlock()
	return ok
&#125;

&#x2F;&#x2F; Remove removes an element from the map.
func (m ConcurrentMap[V]) Remove(key string) &#123;
	&#x2F;&#x2F; Try to get shard.
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	delete(shard.items, key)
	shard.Unlock()
&#125;

&#x2F;&#x2F; RemoveCb is a callback executed in a map.RemoveCb() call, while Lock is held
&#x2F;&#x2F; If returns true, the element will be removed from the map
type RemoveCb[V any] func(key string, v V, exists bool) bool

&#x2F;&#x2F; RemoveCb locks the shard containing the key, retrieves its current value and calls the callback with those params
&#x2F;&#x2F; If callback returns true and element exists, it will remove it from the map
&#x2F;&#x2F; Returns the value returned by the callback (even if element was not present in the map)
func (m ConcurrentMap[V]) RemoveCb(key string, cb RemoveCb[V]) bool &#123;
	&#x2F;&#x2F; Try to get shard.
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	v, ok :&#x3D; shard.items[key]
	remove :&#x3D; cb(key, v, ok)
	if remove &amp;&amp; ok &#123;
		delete(shard.items, key)
	&#125;
	shard.Unlock()
	return remove
&#125;

&#x2F;&#x2F; Pop removes an element from the map and returns it
func (m ConcurrentMap[V]) Pop(key string) (v V, exists bool) &#123;
	&#x2F;&#x2F; Try to get shard.
	shard :&#x3D; m.GetShard(key)
	shard.Lock()
	v, exists &#x3D; shard.items[key]
	delete(shard.items, key)
	shard.Unlock()
	return v, exists
&#125;

&#x2F;&#x2F; IsEmpty checks if map is empty.
func (m ConcurrentMap[V]) IsEmpty() bool &#123;
	return m.Count() &#x3D;&#x3D; 0
&#125;

&#x2F;&#x2F; Used by the Iter &amp; IterBuffered functions to wrap two variables together over a channel,
type Tuple[V any] struct &#123;
	Key string
	Val V
&#125;

&#x2F;&#x2F; Iter returns an iterator which could be used in a for range loop.
&#x2F;&#x2F;
&#x2F;&#x2F; Deprecated: using IterBuffered() will get a better performence
func (m ConcurrentMap[V]) Iter() &lt;-chan Tuple[V] &#123;
	chans :&#x3D; snapshot(m)
	ch :&#x3D; make(chan Tuple[V])
	go fanIn(chans, ch)
	return ch
&#125;

&#x2F;&#x2F; IterBuffered returns a buffered iterator which could be used in a for range loop.
func (m ConcurrentMap[V]) IterBuffered() &lt;-chan Tuple[V] &#123;
	chans :&#x3D; snapshot(m)
	total :&#x3D; 0
	for _, c :&#x3D; range chans &#123;
		total +&#x3D; cap(c)
	&#125;
	ch :&#x3D; make(chan Tuple[V], total)
	go fanIn(chans, ch)
	return ch
&#125;

&#x2F;&#x2F; Clear removes all items from map.
func (m ConcurrentMap[V]) Clear() &#123;
	for item :&#x3D; range m.IterBuffered() &#123;
		m.Remove(item.Key)
	&#125;
&#125;

&#x2F;&#x2F; Returns a array of channels that contains elements in each shard,
&#x2F;&#x2F; which likely takes a snapshot of &#96;m&#96;.
&#x2F;&#x2F; It returns once the size of each buffered channel is determined,
&#x2F;&#x2F; before all the channels are populated using goroutines.
func snapshot[V any](m ConcurrentMap[V]) (chans []chan Tuple[V]) &#123;
	&#x2F;&#x2F;When you access map items before initializing.
	if len(m) &#x3D;&#x3D; 0 &#123;
		panic(&#96;cmap.ConcurrentMap is not initialized. Should run New() before usage.&#96;)
	&#125;
	chans &#x3D; make([]chan Tuple[V], SHARD_COUNT)
	wg :&#x3D; sync.WaitGroup&#123;&#125;
	wg.Add(SHARD_COUNT)
	&#x2F;&#x2F; Foreach shard.
	for index, shard :&#x3D; range m &#123;
		go func(index int, shard *ConcurrentMapShared[V]) &#123;
			&#x2F;&#x2F; Foreach key, value pair.
			shard.RLock()
			chans[index] &#x3D; make(chan Tuple[V], len(shard.items))
			wg.Done()
			for key, val :&#x3D; range shard.items &#123;
				chans[index] &lt;- Tuple[V]&#123;key, val&#125;
			&#125;
			shard.RUnlock()
			close(chans[index])
		&#125;(index, shard)
	&#125;
	wg.Wait()
	return chans
&#125;

&#x2F;&#x2F; fanIn reads elements from channels &#96;chans&#96; into channel &#96;out&#96;
func fanIn[V any](chans []chan Tuple[V], out chan Tuple[V]) &#123;
	wg :&#x3D; sync.WaitGroup&#123;&#125;
	wg.Add(len(chans))
	for _, ch :&#x3D; range chans &#123;
		go func(ch chan Tuple[V]) &#123;
			for t :&#x3D; range ch &#123;
				out &lt;- t
			&#125;
			wg.Done()
		&#125;(ch)
	&#125;
	wg.Wait()
	close(out)
&#125;

&#x2F;&#x2F; Items returns all items as map[string]V
func (m ConcurrentMap[V]) Items() map[string]V &#123;
	tmp :&#x3D; make(map[string]V)

	&#x2F;&#x2F; Insert items to temporary map.
	for item :&#x3D; range m.IterBuffered() &#123;
		tmp[item.Key] &#x3D; item.Val
	&#125;

	return tmp
&#125;

&#x2F;&#x2F; Iterator callbacalled for every key,value found in
&#x2F;&#x2F; maps. RLock is held for all calls for a given shard
&#x2F;&#x2F; therefore callback sess consistent view of a shard,
&#x2F;&#x2F; but not across the shards
type IterCb[V any] func(key string, v V)

&#x2F;&#x2F; Callback based iterator, cheapest way to read
&#x2F;&#x2F; all elements in a map.
func (m ConcurrentMap[V]) IterCb(fn IterCb[V]) &#123;
	for idx :&#x3D; range m &#123;
		shard :&#x3D; (m)[idx]
		shard.RLock()
		for key, value :&#x3D; range shard.items &#123;
			fn(key, value)
		&#125;
		shard.RUnlock()
	&#125;
&#125;

&#x2F;&#x2F; Keys returns all keys as []string
func (m ConcurrentMap[V]) Keys() []string &#123;
	count :&#x3D; m.Count()
	ch :&#x3D; make(chan string, count)
	go func() &#123;
		&#x2F;&#x2F; Foreach shard.
		wg :&#x3D; sync.WaitGroup&#123;&#125;
		wg.Add(SHARD_COUNT)
		for _, shard :&#x3D; range m &#123;
			go func(shard *ConcurrentMapShared[V]) &#123;
				&#x2F;&#x2F; Foreach key, value pair.
				shard.RLock()
				for key :&#x3D; range shard.items &#123;
					ch &lt;- key
				&#125;
				shard.RUnlock()
				wg.Done()
			&#125;(shard)
		&#125;
		wg.Wait()
		close(ch)
	&#125;()

	&#x2F;&#x2F; Generate keys
	keys :&#x3D; make([]string, 0, count)
	for k :&#x3D; range ch &#123;
		keys &#x3D; append(keys, k)
	&#125;
	return keys
&#125;

&#x2F;&#x2F;Reviles ConcurrentMap &quot;private&quot; variables to json marshal.
func (m ConcurrentMap[V]) MarshalJSON() ([]byte, error) &#123;
	&#x2F;&#x2F; Create a temporary map, which will hold all item spread across shards.
	tmp :&#x3D; make(map[string]V)

	&#x2F;&#x2F; Insert items to temporary map.
	for item :&#x3D; range m.IterBuffered() &#123;
		tmp[item.Key] &#x3D; item.Val
	&#125;
	return json.Marshal(tmp)
&#125;

func fnv32(key string) uint32 &#123;
	hash :&#x3D; uint32(2166136261)
	const prime32 &#x3D; uint32(16777619)
	keyLength :&#x3D; len(key)
	for i :&#x3D; 0; i &lt; keyLength; i++ &#123;
		hash *&#x3D; prime32
		hash ^&#x3D; uint32(key[i])
	&#125;
	return hash
&#125;

&#x2F;&#x2F; Reverse process of Marshal.
func (m *ConcurrentMap[V]) UnmarshalJSON(b []byte) (err error) &#123;
 	tmp :&#x3D; make(map[string]V)

 	&#x2F;&#x2F; Unmarshal into a single map.
 	if err :&#x3D; json.Unmarshal(b, &amp;tmp); err !&#x3D; nil &#123;
 		return err
 	&#125;

 	&#x2F;&#x2F; foreach key,value pair in temporary map insert into our concurrent map.
 	for key, val :&#x3D; range tmp &#123;
 		m.Set(key, val)
 	&#125;
	return nil
&#125;</code></pre>

</details>

<p>总结</p>
<ul>
<li>通过这个concurrency-map学习了golang的泛型，golang具体泛型内容可以阅读对应的笔记</li>
<li>说实话作者这种数据结构还是没太理解，不理解why，但是能看懂代码。应该先尝试试着了解数据结构</li>
</ul>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/09/09/archive/golang_concurrency_map/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/09/09/pro_git/"
                            aria-label=": pro_git"
                        >
                            pro_git
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-09-09T12:21:02+08:00">
	
		    Sep 09, 2022
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/09/09/pro_git/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">page 1 of 1</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 kirkzhang. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/nil" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">kirkzhang</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                nil
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-oejgoqwxqxfpwex5ev6ukctltwog5vlqaetakgrj0ys9pwba1gtnkqh5ga78.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
